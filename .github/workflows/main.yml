name: CI/CD Pipeline

on:
  push:
    branches: [main, test]

jobs:
  setup-server:
    runs-on: self-hosted
    # Combined both server jobs using conditions
    steps:
      - name: Set environment variables
        id: set-env
        run: |
          if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
            echo "CACHE_KEY=production" >> $GITHUB_ENV
            echo "NODE_ENV=production" >> $GITHUB_ENV
            echo "PM2_NAME=server2" >> $GITHUB_ENV
          else
            echo "CACHE_KEY=testing" >> $GITHUB_ENV
            echo "NODE_ENV=testing" >> $GITHUB_ENV
            echo "PM2_NAME=test-server2" >> $GITHUB_ENV
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: ${{ github.ref_name }}
          fetch-depth: 1 # Shallow clone for better performance

      - name: Create and secure env file
        run: |
          touch .env
          sudo chmod 600 .env
        working-directory: ${{ github.ref_name }}

      - name: Populate .env file with required production variables
        if: ${{ github.ref_name == 'main' }}
        run: |
          {
            echo NODE_ENV="${{ env.NODE_ENV }}"
            echo PM2_NAME="${{ env.PM2_NAME }}"
            echo DB_USERNAME="${{ secrets.DB_USERNAME }}"
            echo DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            echo DB_NAME="${{ secrets.DB_NAME }}"
            echo DB_PORT="${{ secrets.DB_PORT }}"
            echo MYSQL_SSL_CA="${{ secrets.MYSQL_SSL_CA }}"
            echo MYSQL_SSL_CERT="${{ secrets.MYSQL_SSL_CERT }}"
            echo MYSQL_SSL_KEY="${{ secrets.MYSQL_SSL_KEY }}"
            echo AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            echo AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            echo AWS_FILE_BUCKET="${{ secrets.AWS_FILE_BUCKET }}"
            echo AWS_REGION="${{ secrets.AWS_REGION }}"
            echo JWT_SECRET="${{ secrets.JWT_SECRET }}"
            echo JWT_REFRESH_SECRET="${{ secrets.JWT_REFRESH_SECRET }}"
            echo SALT_ROUNDS="${{ secrets.SALT_ROUNDS }}"
            echo PORT="${{ secrets.PORT }}"
            echo SERVER_IP="${{ secrets.SERVER_IP }}"
            echo COOKIE_SECRET="${{ secrets.COOKIE_SECRET }}"
            echo CLOUDFRONT_BASE_URL="${{ secrets.CLOUDFRONT_BASE_URL }}"
            echo CLOUDFRONT_KEY_PAIR_ID="${{ secrets.CLOUDFRONT_KEY_PAIR_ID }}"
            echo CLOUDFRONT_PRIVATE_KEY="${{ secrets.CLOUDFRONT_PRIVATE_KEY }}"
            echo REVALIDATION_SECRET="${{ secrets.REVALIDATION_SECRET }}"
            echo NEXT_JS_API_URL="${{ secrets.NEXT_JS_API_URL }}"
            echo NEXT_JS_URL="${{ secrets.NEXT_JS_URL }}"
            echo USERS="${{ secrets.USERS }}"
          } >> .env
        working-directory: ${{ github.ref_name }}

      - name: Populate .env file with required production variables
        if: ${{ github.ref_name == 'test' }}
        run: |
          {
            echo "NODE_ENV=\"${{ env.NODE_ENV }}\""
            echo "PM2_NAME=\"${{ env.PM2_NAME }}\""
            echo "DB_USERNAME=\"${{ secrets.DB_USERNAME }}\""
            echo "DB_PASSWORD=\"${{ secrets.DB_PASSWORD }}\""
            echo "DB_NAME=\"${{ secrets.DB_NAME }}\""
            echo "DB_PORT=\"${{ secrets.DB_PORT }}\""
            echo "MYSQL_SSL_CA=\"${{ secrets.MYSQL_SSL_CA }}\""
            echo "MYSQL_SSL_CERT=\"${{ secrets.MYSQL_SSL_CERT }}\""
            echo "MYSQL_SSL_KEY=\"${{ secrets.MYSQL_SSL_KEY }}\""
            echo "AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\""
            echo "AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\""
            echo "AWS_FILE_BUCKET=\"${{ secrets.AWS_FILE_BUCKET }}\""
            echo "AWS_REGION=\"${{ secrets.AWS_REGION }}\""
            echo "JWT_SECRET=\"${{ secrets.JWT_SECRET }}\""
            echo "JWT_REFRESH_SECRET=\"${{ secrets.JWT_REFRESH_SECRET }}\""
            echo "SALT_ROUNDS=\"${{ secrets.SALT_ROUNDS }}\""
            echo "PORT=\"${{ secrets.PORT }}\""
            echo "SERVER_IP=\"${{ secrets.SERVER_IP }}\""
            echo "COOKIE_SECRET=\"${{ secrets.COOKIE_SECRET }}\""
            echo "CLOUDFRONT_BASE_URL=\"${{ secrets.CLOUDFRONT_BASE_URL }}\""
            echo "CLOUDFRONT_KEY_PAIR_ID=\"${{ secrets.CLOUDFRONT_KEY_PAIR_ID }}\""
            echo "CLOUDFRONT_PRIVATE_KEY=\"${{ secrets.CLOUDFRONT_PRIVATE_KEY }}\""
            echo "REVALIDATION_SECRET=\"${{ secrets.REVALIDATION_SECRET }}\""
            echo "NEXT_JS_API_URL=\"${{ secrets.NEXT_JS_API_URL }}\""
            echo "NEXT_JS_URL=\"${{ secrets.NEXT_JS_URL }}\""
            echo "USERS=\"${{ secrets.USERS }}\""
          } >> .env
        working-directory: ${{ github.ref_name }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-server-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-server-${{ env.CACHE_KEY }}
          working-directory: ${{ github.ref_name }}

      - name: Install dependencies
        run: |
          npm ci
        working-directory: ${{ github.ref_name }}

      - name: Setup database
        run: |
          npm run migrate
          npm run seed
        working-directory: ${{ github.ref_name }}

  deploy:
    runs-on: self-hosted
    needs: setup-server
    steps:
      - name: Install pm2 globally
        run: |
          npm install pm2@latest -g
          pm2 update

      - name: Stop existing processes
        continue-on-error: true
        run: |
          pm2 delete ${{ env.PM2_NAME }}
          pm2 flush

      - name: Start server with pm2
        run: |
          echo "Starting application with PM2..."
          pm2 start pm2.config.js
          pm2 save
        working-directory: ${{ github.ref_name }}

      - name: Restart Nginx
        run: |
          echo "Reloading Nginx..."
          sudo systemctl reload nginx
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
